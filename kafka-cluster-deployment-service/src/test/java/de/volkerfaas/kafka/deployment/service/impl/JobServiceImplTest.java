package de.volkerfaas.kafka.deployment.service.impl;

import de.volkerfaas.kafka.deployment.config.Config;
import de.volkerfaas.kafka.deployment.config.GitConfig;
import de.volkerfaas.kafka.deployment.integration.GitRepository;
import de.volkerfaas.kafka.deployment.integration.GitStatusRepository;
import de.volkerfaas.kafka.deployment.integration.JobProducer;
import de.volkerfaas.kafka.deployment.integration.JobRepository;
import de.volkerfaas.kafka.deployment.service.GitService;
import de.volkerfaas.kafka.deployment.service.TaskService;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import java.security.InvalidKeyException;
import java.security.NoSuchAlgorithmException;

import static org.junit.jupiter.api.Assertions.assertFalse;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.mockito.Mockito.mock;

public class JobServiceImplTest {

    private JobServiceImpl jobService;

    @BeforeEach
    void init() {
        final GitConfig gitConfig = new GitConfig();
        gitConfig.setSecret("v1xesaB.97bhj#76lHtio+9812bHGF");
        final Config config = new Config();
        config.setGit(gitConfig);
        final GitRepository gitRepository = mock(GitRepository.class);
        final GitStatusRepository gitStatusRepository = mock(GitStatusRepository.class);
        final JobRepository jobRepository = mock(JobRepository.class);
        final JobProducer jobProducer = mock(JobProducer.class);
        final GitService gitService = new GitServiceImpl(config, gitRepository, gitStatusRepository);
        final TaskService taskService = new TaskServiceImpl(config, gitService);
        this.jobService = new JobServiceImpl(config, taskService, gitService, jobRepository, jobProducer);
    }

    @Test
    void testIsValidGitHubSignature() throws NoSuchAlgorithmException, InvalidKeyException {
        String signature = "sha256=3bb57f95f528462c0f840ca344047957d071196f0a8eebc4239a99c9dc0b0d7c";
        String payload = "{\"ref\":\"refs/heads/master\",\"before\":\"271663bb583deb1afe63328501a33d69c01607f7\",\"after\":\"d6b21911aa37811ed262cf9f33051d12c7779b22\",\"repository\":{\"id\":315062683,\"node_id\":\"MDEwOlJlcG9zaXRvcnkzMTUwNjI2ODM=\",\"name\":\"kafka-cluster-topology\",\"full_name\":\"Bluezdrive/kafka-cluster-topology\",\"private\":false,\"owner\":{\"name\":\"Bluezdrive\",\"email\":\"volker.faas@arcor.de\",\"login\":\"Bluezdrive\",\"id\":5399588,\"node_id\":\"MDQ6VXNlcjUzOTk1ODg=\",\"avatar_url\":\"https://avatars1.githubusercontent.com/u/5399588?v=4\",\"gravatar_id\":\"\",\"url\":\"https://api.github.com/users/Bluezdrive\",\"html_url\":\"https://github.com/Bluezdrive\",\"followers_url\":\"https://api.github.com/users/Bluezdrive/followers\",\"following_url\":\"https://api.github.com/users/Bluezdrive/following{/other_user}\",\"gists_url\":\"https://api.github.com/users/Bluezdrive/gists{/gist_id}\",\"starred_url\":\"https://api.github.com/users/Bluezdrive/starred{/owner}{/repo}\",\"subscriptions_url\":\"https://api.github.com/users/Bluezdrive/subscriptions\",\"organizations_url\":\"https://api.github.com/users/Bluezdrive/orgs\",\"repos_url\":\"https://api.github.com/users/Bluezdrive/repos\",\"events_url\":\"https://api.github.com/users/Bluezdrive/events{/privacy}\",\"received_events_url\":\"https://api.github.com/users/Bluezdrive/received_events\",\"type\":\"User\",\"site_admin\":false},\"html_url\":\"https://github.com/Bluezdrive/kafka-cluster-topology\",\"description\":null,\"fork\":false,\"url\":\"https://github.com/Bluezdrive/kafka-cluster-topology\",\"forks_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/forks\",\"keys_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/keys{/key_id}\",\"collaborators_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/collaborators{/collaborator}\",\"teams_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/teams\",\"hooks_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/hooks\",\"issue_events_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/issues/events{/number}\",\"events_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/events\",\"assignees_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/assignees{/user}\",\"branches_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/branches{/branch}\",\"tags_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/tags\",\"blobs_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/git/blobs{/sha}\",\"git_tags_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/git/tags{/sha}\",\"git_refs_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/git/refs{/sha}\",\"trees_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/git/trees{/sha}\",\"statuses_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/statuses/{sha}\",\"languages_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/languages\",\"stargazers_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/stargazers\",\"contributors_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/contributors\",\"subscribers_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/subscribers\",\"subscription_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/subscription\",\"commits_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/commits{/sha}\",\"git_commits_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/git/commits{/sha}\",\"comments_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/comments{/number}\",\"issue_comment_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/issues/comments{/number}\",\"contents_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/contents/{+path}\",\"compare_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/compare/{base}...{head}\",\"merges_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/merges\",\"archive_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/{archive_format}{/ref}\",\"downloads_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/downloads\",\"issues_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/issues{/number}\",\"pulls_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/pulls{/number}\",\"milestones_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/milestones{/number}\",\"notifications_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/notifications{?since,all,participating}\",\"labels_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/labels{/name}\",\"releases_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/releases{/id}\",\"deployments_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/deployments\",\"created_at\":1606057092,\"updated_at\":\"2020-12-20T09:57:38Z\",\"pushed_at\":1608648713,\"git_url\":\"git://github.com/Bluezdrive/kafka-cluster-topology.git\",\"ssh_url\":\"git@github.com:Bluezdrive/kafka-cluster-topology.git\",\"clone_url\":\"https://github.com/Bluezdrive/kafka-cluster-topology.git\",\"svn_url\":\"https://github.com/Bluezdrive/kafka-cluster-topology\",\"homepage\":null,\"size\":4,\"stargazers_count\":0,\"watchers_count\":0,\"language\":\"Shell\",\"has_issues\":true,\"has_projects\":true,\"has_downloads\":true,\"has_wiki\":true,\"has_pages\":false,\"forks_count\":0,\"mirror_url\":null,\"archived\":false,\"disabled\":false,\"open_issues_count\":0,\"license\":null,\"forks\":0,\"open_issues\":0,\"watchers\":0,\"default_branch\":\"master\",\"stargazers\":0,\"master_branch\":\"master\"},\"pusher\":{\"name\":\"Bluezdrive\",\"email\":\"volker.faas@arcor.de\"},\"sender\":{\"login\":\"Bluezdrive\",\"id\":5399588,\"node_id\":\"MDQ6VXNlcjUzOTk1ODg=\",\"avatar_url\":\"https://avatars1.githubusercontent.com/u/5399588?v=4\",\"gravatar_id\":\"\",\"url\":\"https://api.github.com/users/Bluezdrive\",\"html_url\":\"https://github.com/Bluezdrive\",\"followers_url\":\"https://api.github.com/users/Bluezdrive/followers\",\"following_url\":\"https://api.github.com/users/Bluezdrive/following{/other_user}\",\"gists_url\":\"https://api.github.com/users/Bluezdrive/gists{/gist_id}\",\"starred_url\":\"https://api.github.com/users/Bluezdrive/starred{/owner}{/repo}\",\"subscriptions_url\":\"https://api.github.com/users/Bluezdrive/subscriptions\",\"organizations_url\":\"https://api.github.com/users/Bluezdrive/orgs\",\"repos_url\":\"https://api.github.com/users/Bluezdrive/repos\",\"events_url\":\"https://api.github.com/users/Bluezdrive/events{/privacy}\",\"received_events_url\":\"https://api.github.com/users/Bluezdrive/received_events\",\"type\":\"User\",\"site_admin\":false},\"created\":false,\"deleted\":false,\"forced\":false,\"base_ref\":null,\"compare\":\"https://github.com/Bluezdrive/kafka-cluster-topology/compare/271663bb583d...d6b21911aa37\",\"commits\":[{\"id\":\"d6b21911aa37811ed262cf9f33051d12c7779b22\",\"tree_id\":\"e986d2e24e808aeee99ff21f9d9e9eed015a65b1\",\"distinct\":true,\"message\":\"Updated domain de.volkerfaas.test\",\"timestamp\":\"2020-12-20T14:41:40+01:00\",\"url\":\"https://github.com/Bluezdrive/kafka-cluster-topology/commit/d6b21911aa37811ed262cf9f33051d12c7779b22\",\"author\":{\"name\":\"Bluezdrive\",\"email\":\"bluezdrive@volkerfaas.de\",\"username\":\"Bluezdrive\"},\"committer\":{\"name\":\"Bluezdrive\",\"email\":\"bluezdrive@volkerfaas.de\",\"username\":\"Bluezdrive\"},\"added\":[],\"removed\":[],\"modified\":[]}],\"head_commit\":{\"id\":\"d6b21911aa37811ed262cf9f33051d12c7779b22\",\"tree_id\":\"e986d2e24e808aeee99ff21f9d9e9eed015a65b1\",\"distinct\":true,\"message\":\"Updated domain de.volkerfaas.test\",\"timestamp\":\"2020-12-20T14:41:40+01:00\",\"url\":\"https://github.com/Bluezdrive/kafka-cluster-topology/commit/d6b21911aa37811ed262cf9f33051d12c7779b22\",\"author\":{\"name\":\"Bluezdrive\",\"email\":\"bluezdrive@volkerfaas.de\",\"username\":\"Bluezdrive\"},\"committer\":{\"name\":\"Bluezdrive\",\"email\":\"bluezdrive@volkerfaas.de\",\"username\":\"Bluezdrive\"},\"added\":[],\"removed\":[],\"modified\":[]}}";
        final boolean validGitHubSignature = jobService.isValidGitHubSignature(signature, payload);
        assertTrue(validGitHubSignature);
    }

    @Test
    void testIsNotValidGitHubSignature() throws NoSuchAlgorithmException, InvalidKeyException {
        String signature = "sha256=3bb57f95f528462c0f840ca344047957d071196f0a8eebc4239a99c9dc0b0d9b";
        String payload = "{\"ref\":\"refs/heads/master\",\"before\":\"271663bb583deb1afe63328501a33d69c01607f7\",\"after\":\"d6b21911aa37811ed262cf9f33051d12c7779b22\",\"repository\":{\"id\":315062683,\"node_id\":\"MDEwOlJlcG9zaXRvcnkzMTUwNjI2ODM=\",\"name\":\"kafka-cluster-topology\",\"full_name\":\"Bluezdrive/kafka-cluster-topology\",\"private\":false,\"owner\":{\"name\":\"Bluezdrive\",\"email\":\"volker.faas@arcor.de\",\"login\":\"Bluezdrive\",\"id\":5399588,\"node_id\":\"MDQ6VXNlcjUzOTk1ODg=\",\"avatar_url\":\"https://avatars1.githubusercontent.com/u/5399588?v=4\",\"gravatar_id\":\"\",\"url\":\"https://api.github.com/users/Bluezdrive\",\"html_url\":\"https://github.com/Bluezdrive\",\"followers_url\":\"https://api.github.com/users/Bluezdrive/followers\",\"following_url\":\"https://api.github.com/users/Bluezdrive/following{/other_user}\",\"gists_url\":\"https://api.github.com/users/Bluezdrive/gists{/gist_id}\",\"starred_url\":\"https://api.github.com/users/Bluezdrive/starred{/owner}{/repo}\",\"subscriptions_url\":\"https://api.github.com/users/Bluezdrive/subscriptions\",\"organizations_url\":\"https://api.github.com/users/Bluezdrive/orgs\",\"repos_url\":\"https://api.github.com/users/Bluezdrive/repos\",\"events_url\":\"https://api.github.com/users/Bluezdrive/events{/privacy}\",\"received_events_url\":\"https://api.github.com/users/Bluezdrive/received_events\",\"type\":\"User\",\"site_admin\":false},\"html_url\":\"https://github.com/Bluezdrive/kafka-cluster-topology\",\"description\":null,\"fork\":false,\"url\":\"https://github.com/Bluezdrive/kafka-cluster-topology\",\"forks_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/forks\",\"keys_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/keys{/key_id}\",\"collaborators_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/collaborators{/collaborator}\",\"teams_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/teams\",\"hooks_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/hooks\",\"issue_events_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/issues/events{/number}\",\"events_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/events\",\"assignees_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/assignees{/user}\",\"branches_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/branches{/branch}\",\"tags_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/tags\",\"blobs_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/git/blobs{/sha}\",\"git_tags_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/git/tags{/sha}\",\"git_refs_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/git/refs{/sha}\",\"trees_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/git/trees{/sha}\",\"statuses_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/statuses/{sha}\",\"languages_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/languages\",\"stargazers_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/stargazers\",\"contributors_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/contributors\",\"subscribers_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/subscribers\",\"subscription_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/subscription\",\"commits_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/commits{/sha}\",\"git_commits_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/git/commits{/sha}\",\"comments_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/comments{/number}\",\"issue_comment_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/issues/comments{/number}\",\"contents_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/contents/{+path}\",\"compare_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/compare/{base}...{head}\",\"merges_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/merges\",\"archive_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/{archive_format}{/ref}\",\"downloads_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/downloads\",\"issues_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/issues{/number}\",\"pulls_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/pulls{/number}\",\"milestones_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/milestones{/number}\",\"notifications_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/notifications{?since,all,participating}\",\"labels_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/labels{/name}\",\"releases_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/releases{/id}\",\"deployments_url\":\"https://api.github.com/repos/Bluezdrive/kafka-cluster-topology/deployments\",\"created_at\":1606057092,\"updated_at\":\"2020-12-20T09:57:38Z\",\"pushed_at\":1608648713,\"git_url\":\"git://github.com/Bluezdrive/kafka-cluster-topology.git\",\"ssh_url\":\"git@github.com:Bluezdrive/kafka-cluster-topology.git\",\"clone_url\":\"https://github.com/Bluezdrive/kafka-cluster-topology.git\",\"svn_url\":\"https://github.com/Bluezdrive/kafka-cluster-topology\",\"homepage\":null,\"size\":4,\"stargazers_count\":0,\"watchers_count\":0,\"language\":\"Shell\",\"has_issues\":true,\"has_projects\":true,\"has_downloads\":true,\"has_wiki\":true,\"has_pages\":false,\"forks_count\":0,\"mirror_url\":null,\"archived\":false,\"disabled\":false,\"open_issues_count\":0,\"license\":null,\"forks\":0,\"open_issues\":0,\"watchers\":0,\"default_branch\":\"master\",\"stargazers\":0,\"master_branch\":\"master\"},\"pusher\":{\"name\":\"Bluezdrive\",\"email\":\"volker.faas@arcor.de\"},\"sender\":{\"login\":\"Bluezdrive\",\"id\":5399588,\"node_id\":\"MDQ6VXNlcjUzOTk1ODg=\",\"avatar_url\":\"https://avatars1.githubusercontent.com/u/5399588?v=4\",\"gravatar_id\":\"\",\"url\":\"https://api.github.com/users/Bluezdrive\",\"html_url\":\"https://github.com/Bluezdrive\",\"followers_url\":\"https://api.github.com/users/Bluezdrive/followers\",\"following_url\":\"https://api.github.com/users/Bluezdrive/following{/other_user}\",\"gists_url\":\"https://api.github.com/users/Bluezdrive/gists{/gist_id}\",\"starred_url\":\"https://api.github.com/users/Bluezdrive/starred{/owner}{/repo}\",\"subscriptions_url\":\"https://api.github.com/users/Bluezdrive/subscriptions\",\"organizations_url\":\"https://api.github.com/users/Bluezdrive/orgs\",\"repos_url\":\"https://api.github.com/users/Bluezdrive/repos\",\"events_url\":\"https://api.github.com/users/Bluezdrive/events{/privacy}\",\"received_events_url\":\"https://api.github.com/users/Bluezdrive/received_events\",\"type\":\"User\",\"site_admin\":false},\"created\":false,\"deleted\":false,\"forced\":false,\"base_ref\":null,\"compare\":\"https://github.com/Bluezdrive/kafka-cluster-topology/compare/271663bb583d...d6b21911aa37\",\"commits\":[{\"id\":\"d6b21911aa37811ed262cf9f33051d12c7779b22\",\"tree_id\":\"e986d2e24e808aeee99ff21f9d9e9eed015a65b1\",\"distinct\":true,\"message\":\"Updated domain de.volkerfaas.test\",\"timestamp\":\"2020-12-20T14:41:40+01:00\",\"url\":\"https://github.com/Bluezdrive/kafka-cluster-topology/commit/d6b21911aa37811ed262cf9f33051d12c7779b22\",\"author\":{\"name\":\"Bluezdrive\",\"email\":\"bluezdrive@volkerfaas.de\",\"username\":\"Bluezdrive\"},\"committer\":{\"name\":\"Bluezdrive\",\"email\":\"bluezdrive@volkerfaas.de\",\"username\":\"Bluezdrive\"},\"added\":[],\"removed\":[],\"modified\":[]}],\"head_commit\":{\"id\":\"d6b21911aa37811ed262cf9f33051d12c7779b22\",\"tree_id\":\"e986d2e24e808aeee99ff21f9d9e9eed015a65b1\",\"distinct\":true,\"message\":\"Updated domain de.volkerfaas.test\",\"timestamp\":\"2020-12-20T14:41:40+01:00\",\"url\":\"https://github.com/Bluezdrive/kafka-cluster-topology/commit/d6b21911aa37811ed262cf9f33051d12c7779b22\",\"author\":{\"name\":\"Bluezdrive\",\"email\":\"bluezdrive@volkerfaas.de\",\"username\":\"Bluezdrive\"},\"committer\":{\"name\":\"Bluezdrive\",\"email\":\"bluezdrive@volkerfaas.de\",\"username\":\"Bluezdrive\"},\"added\":[],\"removed\":[],\"modified\":[]}}";
        final boolean validGitHubSignature = jobService.isValidGitHubSignature(signature, payload);
        assertFalse(validGitHubSignature);
    }

}
